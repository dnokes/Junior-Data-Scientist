<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CaRMS | Programs by Province</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e9eef5; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { font-family: ui-serif, Georgia, "Times New Roman", Times, serif; font-size: 26px; margin: 0 0 10px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; overflow:hidden; }
    #plot { width: 100%; height: 660px; }
    .sub { color: rgba(255,255,255,0.65); font-size: 13px; margin: 0 0 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Residency Programs by Province</h1>
    <p class="sub">Choropleth view from the gold layer (province aggregation).</p>
    <div class="card"><div id="plot"></div></div>
  </div>

  <script>
    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return await r.json();
    }

    function hoverText(d){
      return `<b>${d.name}</b> (${d.province})<br>` +
             `Programs: ${d.programs ?? d.program_count ?? "n/a"}`; // supports either key
    }

    async function render(){
      const [geojson, data] = await Promise.all([
        fetchJSON("/map/canada.geojson"),
        fetchJSON("/map/data.json")
      ]);

      // Expecting: [{ province:"AB", name:"Alberta", programs:84 }, ...]
      const locations = data.map(d => d.province);
      const z = data.map(d => d.programs ?? d.program_count ?? 0);
      const text = data.map(d => hoverText(d));

      const trace = {
        type: "choropleth",
        geojson,
        featureidkey: "properties.province",
        locations,
        z,
        text,
        hovertemplate: "%{text}<extra></extra>",
        marker: { line: { width: 0.6 } },
        colorbar: { title: "Programs" }
      };

      const layout = {
        margin: { l: 16, r: 16, t: 10, b: 10 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        geo: {
          scope: "north america",
          projection: { type: "mercator" },
          fitbounds: "locations",
          showframe: false,
          showcoastlines: false,
          showcountries: false,
          showsubunits: true,
          subunitcolor: "rgba(255,255,255,0.10)",
          bgcolor: "rgba(0,0,0,0)"
        },
        font: { color: "rgba(255,255,255,0.88)" }
      };

      Plotly.react("plot", [trace], layout, {displayModeBar:false, responsive:true});
    }

    render().catch(err => {
      console.error(err);
      document.getElementById("plot").innerHTML =
        `<div style="padding:16px;color:rgba(255,255,255,0.75)">
          <b>Map failed to load.</b><br>${err.message}
        </div>`;
    });
  </script>
</body>
</html>
